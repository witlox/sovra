
# Cross-Domain Data Sharing

## Overview

Sovra enables secure data sharing between federated organizations using shared workspaces.

## Concepts

### Workspace

A shared cryptographic domain where multiple organizations can encrypt/decrypt data.

**Components:**
- Multiple participating organizations
- Single Data Encryption Key (DEK)
- Distributed access policies
- Cross-organization audit trail

### Key Exchange

DEK is generated by workspace initiator and wrapped for each participant.

## Use Cases

### Research Collaboration

Universities sharing patient data for cancer research:

```bash
sovra-cli workspace create \
  --name cancer-research \
  --participants eth-zurich,epfl,unige \
  --classification CONFIDENTIAL \
  --purpose "Oncology research collaboration"
```

### Government Intelligence

Agencies sharing classified intelligence:

```bash
sovra-cli workspace create \
  --name defense-intel \
  --participants mil-org-1,intel-org-2 \
  --classification SECRET \
  --mode air-gap
```

### Supply Chain

Manufacturers and suppliers sharing logistics data:

```bash
sovra-cli workspace create \
  --name supplier-network \
  --participants manufacturer,supplier-1,supplier-2 \
  --policies supply-chain-policy.rego
```

## Creating Workspaces

### Step 1: Initialize Federation

```bash
# Both organizations must be federated first
sovra-cli federation status partner-org
```

### Step 2: Create Workspace

Initiator (Org A):
```bash
sovra-cli workspace create \
  --name joint-project \
  --participants org-a,org-b,org-c \
  --classification CONFIDENTIAL \
  --crk-sign org-a-crk.json
```

What happens:
1. System generates DEK (Data Encryption Key)
2. Requests public keys from Org B and C
3. Wraps DEK with each participant's public key
4. Sends wrapped keys to participants
5. Participants acknowledge receipt

### Step 3: Verify Workspace

All participants:
```bash
sovra-cli workspace list
sovra-cli workspace info joint-project
```

## Using Workspaces

### Encrypt Data

Any participant can encrypt:

```bash
# Encrypt file
sovra-cli workspace encrypt \
  --workspace joint-project \
  --input sensitive-data.csv \
  --output encrypted.dat

# Encrypt stdin
echo "secret message" | sovra-cli workspace encrypt \
  --workspace joint-project \
  --output message.enc
```

### Decrypt Data

Any participant can decrypt:

```bash
# Decrypt file
sovra-cli workspace decrypt \
  --workspace joint-project \
  --input encrypted.dat \
  --output decrypted.csv

# Decrypt to stdout
sovra-cli workspace decrypt \
  --workspace joint-project \
  --input message.enc
```

### Share Encrypted Data

```bash
# Org A encrypts
echo "shared data" | sovra-cli workspace encrypt \
  --workspace joint-project > data.enc

# Send data.enc to Org B (email, S3, etc.)

# Org B decrypts
sovra-cli workspace decrypt \
  --workspace joint-project \
  --input data.enc
```

## Access Control

### Policy Example

```rego
# policy/joint-project.rego
package workspace.joint_project

import future.keywords.if

# Default deny
default allow = false

# Only researchers can decrypt
allow if {
    input.role == "researcher"
    input.purpose == "analysis"
    input.time >= workspace.start_time
    input.time <= workspace.end_time
}

# Org admins can always access
allow if {
    input.role == "admin"
}

# Log all denials
deny_reason := "unauthorized role" if {
    not input.role in ["researcher", "admin"]
}
```

### Apply Policy

```bash
sovra-cli policy create \
  --workspace joint-project \
  --policy policy/joint-project.rego \
  --crk-sign org-a-crk.json
```

## Audit Trail

### View Workspace Audit Log

```bash
# Last 100 operations
sovra-cli audit query \
  --workspace joint-project \
  --limit 100

# Filter by organization
sovra-cli audit query \
  --workspace joint-project \
  --org org-b

# Filter by operation
sovra-cli audit query \
  --workspace joint-project \
  --operation decrypt
```

### Audit Event Example

```json
{
  "workspace": "joint-project",
  "operation": "decrypt",
  "org": "org-b",
  "user": "researcher@org-b.edu",
  "timestamp": "2026-01-29T14:30:00Z",
  "purpose": "data analysis",
  "result": "success",
  "data_hash": "sha256:abc123..."
}
```

**Important:** ALL participants see ALL audit events.

## GDPR Compliance

### Purpose Limitation

```bash
# Specify purpose when creating workspace
sovra-cli workspace create \
  --name patient-data \
  --purpose "COVID-19 treatment research" \
  ...
```

Policies enforce purpose:
```rego
allow if {
    input.purpose == workspace.purpose
}
```

### Data Minimization

Only workspace participants can access data:
```bash
# Non-participant cannot decrypt
sovra-cli workspace decrypt \
  --workspace joint-project \
  --input data.enc

Error: unauthorized - not a workspace participant
```

### Consent Management

All participants must acknowledge:
```bash
sovra-cli workspace join \
  --workspace joint-project \
  --consent-sign org-b-crk.json
```

### Right to Erasure

Any participant can revoke access:
```bash
sovra-cli workspace leave \
  --workspace joint-project \
  --crk-sign org-b-crk.json
```

All other participants notified.

### Audit Trail

Complete operation history:
```bash
# Export for compliance
sovra-cli audit export \
  --workspace joint-project \
  --format json \
  --output audit-2026-Q1.json
```

## Air-Gap Support

For SECRET classification:

### Creating Air-Gap Workspace

```bash
# On connected machine
sovra-cli workspace create \
  --name classified-intel \
  --participants mil-1,intel-2 \
  --classification SECRET \
  --mode air-gap \
  --output workspace-package/
```

### Transfer to Air-Gap

```bash
# Copy to USB
cp -r workspace-package/ /media/usb/

# On air-gap machine
sovra-cli workspace import \
  --input /media/usb/workspace-package/
```

### Synchronization

```bash
# Export operations (air-gap machine)
sovra-cli workspace export-ops \
  --workspace classified-intel \
  --output /media/usb/ops-export/

# Import operations (connected machine)
sovra-cli workspace import-ops \
  --input /media/usb/ops-export/
```

## Workspace Lifecycle

### Expiration

```bash
# Create with expiration
sovra-cli workspace create \
  --name temp-project \
  --expires "2026-12-31" \
  ...

# Extend expiration
sovra-cli workspace extend \
  --workspace temp-project \
  --expires "2027-12-31" \
  --crk-sign org-a-crk.json
```

### Archival

```bash
# Archive workspace (read-only)
sovra-cli workspace archive \
  --workspace completed-project \
  --crk-sign org-a-crk.json
```

### Deletion

```bash
# Requires all participants to sign
sovra-cli workspace delete \
  --workspace old-project \
  --crk-sign org-a-crk.json

# Other participants must also sign
# (collect signatures from all participants)
```

## Advanced Features

### Key Rotation

```bash
# Rotate DEK (re-wrap for all participants)
sovra-cli workspace rotate-key \
  --workspace joint-project \
  --crk-sign org-a-crk.json
```

### Add Participant

```bash
# Existing participants vote
sovra-cli workspace add-participant \
  --workspace joint-project \
  --new-participant org-d \
  --crk-sign org-a-crk.json

# Requires majority approval
```

### Remove Participant

```bash
sovra-cli workspace remove-participant \
  --workspace joint-project \
  --participant org-c \
  --crk-sign org-a-crk.json
```

## Troubleshooting

### Key Exchange Fails

```bash
# Verify federation
sovra-cli federation status partner-org

# Test connectivity
curl -k https://sovra-partner.example.org/healthz

# Re-request keys
sovra-cli workspace refresh-keys \
  --workspace joint-project
```

### Decryption Fails

```bash
# Verify workspace membership
sovra-cli workspace participants joint-project

# Check policy
sovra-cli policy get \
  --workspace joint-project

# View audit for errors
sovra-cli audit query \
  --workspace joint-project \
  --result error
```

## Security Considerations

1. **DEK Security**: DEK never leaves Vault unencrypted
2. **Transport**: All key exchange via mTLS
3. **Storage**: Wrapped keys stored encrypted
4. **Audit**: All operations logged immutably
5. **Revocation**: Instant across all participants

---

**Next:** [Federation Overview](README.md) <!-- Protocol and trust model guides coming soon -->
