# Sovra Architecture - Federated Model

## Overview

Sovra is a federated control plane system enabling organizations to maintain cryptographic sovereignty while securely sharing data with partner organizations.

### Federated Architecture

```
Organization A              Organization B              Organization C
┌───────────────┐           ┌───────────────┐           ┌───────────────┐
│ Sovra Control │◄─mTLS────►│ Sovra Control │◄─mTLS────►│ Sovra Control │
│ ├─ API        │           │ ├─ API        │           │ ├─ API        │
│ ├─ Policy     │           │ ├─ Policy     │           │ ├─ Policy     │
│ ├─ Lifecycle  │           │ ├─ Lifecycle  │           │ ├─ Lifecycle  │
│ ├─ Audit      │           │ ├─ Audit      │           │ ├─ Audit      │
│ └─ Federation │           │ └─ Federation │           │ └─ Federation │
└───────┬───────┘           └───────┬───────┘           └───────┬───────┘
        │mTLS                       │mTLS                       │mTLS
┌───────▼───────┐           ┌───────▼───────┐           ┌───────▼───────┐
│ Edge Nodes    │           │ Edge Nodes    │           │ Edge Nodes    │
│ (Vault)       │           │ (Vault)       │           │ (Vault)       │
└───────────────┘           └───────────────┘           └───────────────┘
```

## Components

### Control Plane (Single Binary)

The control plane runs as a single `sovra-api-gateway` binary that integrates all services:

| Component | Responsibility |
|-----------|---------------|
| **API Gateway** | mTLS termination, routing, auth |
| **Policy Engine** | OPA-based access control |
| **Key Lifecycle** | Key creation, rotation, expiry |
| **Audit Service** | Immutable audit logs |
| **Federation Manager** | Cross-org communication |

> **Note:** While the documentation may reference separate services (e.g., `sovra-policy-engine`, `sovra-audit-service`), the actual implementation packages all components into a single deployable binary for simplified operations.

### Edge Nodes (Vault)

- HashiCorp Vault (3-node Raft)
- Edge Agent (health, certs)
- OPA (local policy cache)
- Audit forwarder

## Federation

### Trust Model

Each organization signs their own federation certificate with their root key. No cross-signing required.

```
Org A Root Key → Signs Org A Federation Cert
                       ↓ bilateral mTLS
Org B Root Key → Signs Org B Federation Cert
```

### Establishment

1. Generate federation CSR
2. Exchange CSRs (out-of-band)
3. Sign with organization root keys
4. Establish mTLS channel
5. Exchange capabilities

## Cross-Domain Sharing

### Shared Workspace

```
Workspace Components:
├─ Participants (multiple orgs)
├─ Data Encryption Key (DEK)
│   ├─ Generated by initiator
│   ├─ Wrapped for each participant
│   └─ Stored in workspace Vault
├─ Access Policies (OPA)
└─ Distributed Audit Trail
```

### Key Exchange

1. Initiator creates workspace, generates DEK
2. Requests public keys from participants
3. Wraps DEK for each participant
4. Sends wrapped keys
5. Participants unwrap and store

### Data Operations

**Encryption:**
```
App → Workspace API → Vault (DEK) → Encrypt → Audit
```

**Decryption:**
```
App → Policy Check → Workspace Vault → Decrypt → Audit (both orgs)
```

## Security

### Defense in Depth

1. Network: mTLS everywhere
2. Auth: CRK signatures, certificates
3. Authz: OPA + Vault policies
4. Encryption: TLS 1.3, AES-256
5. Audit: Immutable logs
6. Monitoring: Anomaly detection

### Zero-Knowledge

Control plane never sees:
- Plaintext data
- Unencrypted keys
- Raw audit content

## Deployment Models

| Mode | Classification | Connectivity | Use Case |
|------|---------------|--------------|----------|
| **Connected** | CONFIDENTIAL | Internet | Research, commercial |
| **Air-Gap** | SECRET | Physical isolation | Military, intel |
| **Hybrid** | Mixed | Selective | Multi-level security |

## Technology

- Go 1.22+ (services)
- PostgreSQL 15+ (data)
- Vault 1.16+ (secrets)
- OPA 0.61+ (policy)
- mTLS (networking)

