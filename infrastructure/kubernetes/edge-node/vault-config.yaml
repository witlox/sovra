apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-config
  labels:
    app.kubernetes.io/name: vault
data:
  vault.hcl: |
    ui = true

    listener "tcp" {
      address         = "[::]:8200"
      cluster_address = "[::]:8201"
      tls_cert_file   = "/vault/tls/tls.crt"
      tls_key_file    = "/vault/tls/tls.key"
      tls_client_ca_file = "/vault/tls/ca.crt"
      tls_require_and_verify_client_cert = false
      telemetry {
        unauthenticated_metrics_access = true
      }
    }

    storage "raft" {
      path = "/vault/data"
      
      retry_join {
        leader_api_addr = "https://vault-0.vault:8200"
        leader_ca_cert_file = "/vault/tls/ca.crt"
        leader_client_cert_file = "/vault/tls/tls.crt"
        leader_client_key_file = "/vault/tls/tls.key"
      }
      retry_join {
        leader_api_addr = "https://vault-1.vault:8200"
        leader_ca_cert_file = "/vault/tls/ca.crt"
        leader_client_cert_file = "/vault/tls/tls.crt"
        leader_client_key_file = "/vault/tls/tls.key"
      }
      retry_join {
        leader_api_addr = "https://vault-2.vault:8200"
        leader_ca_cert_file = "/vault/tls/ca.crt"
        leader_client_cert_file = "/vault/tls/tls.crt"
        leader_client_key_file = "/vault/tls/tls.key"
      }
    }

    service_registration "kubernetes" {}

    # Telemetry for Prometheus
    telemetry {
      prometheus_retention_time = "30s"
      disable_hostname = true
    }

    # API configuration
    api_addr = "https://vault.sovra.svc.cluster.local:8200"
    cluster_addr = "https://vault.sovra.svc.cluster.local:8201"

    # Performance tuning
    default_lease_ttl = "768h"
    max_lease_ttl = "8760h"

    # Audit logging
    # Enable via API after initialization
